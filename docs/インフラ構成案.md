# SaaS管理ツール POC インフラ構成案

---

## 1. 方針

POCはシンプルに素早くデプロイし、デモできる状態にすることを優先する。本番移行時にIaC化・セキュリティ強化を行う。

| 項目 | POC | 本番移行時 |
| --- | --- | --- |
| 構成管理 | 手動セットアップ | Terraform |
| 環境 | 1環境（dev兼デモ） | dev / prod の2環境 |
| デプロイ | `az webapp deploy` or Git push | GitHub Actions CI/CD |
| セキュリティ | IP制限 + Entra ID認証 | VNet統合 + Key Vault + 監視 |

## 2. POC構成（Azure）

Entra IDと同一テナントで管理でき、認証との親和性が最も高いAzureを選択する。

| コンポーネント | サービス | スペック | 月額目安 |
| --- | --- | --- | --- |
| アプリケーション | Azure App Service | Basic B1（1コア / 1.75GB RAM） | 約2,000円 |
| データベース | Azure Database for PostgreSQL Flexible Server | Burstable B1ms（1コア / 2GB RAM） | 約2,500円 |
| SSL証明書 | App Serviceマネージド証明書 | 無料 | |
| **合計** | | | **約4,500円/月** |

POCではKey Vault・Log Analytics・VNet統合は省略し、環境変数でシークレットを管理する。

### 構成図

```
[ユーザー（社内ネットワーク）]
  ↓ HTTPS（App Service IP制限で社内IPのみ許可）
[Azure App Service] ── Rails 8 アプリ
  │  ├─ Solid Queue（バックグラウンドジョブ）
  │  └─ Puma（Webサーバー）
  ↓ 
[Azure Database for PostgreSQL Flexible Server]

外部API:
  → Microsoft Graph API（Entra ID認証・ユーザー同期）
  → Power Automate Workflows Webhook（Teams通知）
```

### セキュリティ（POC最低限）

| 対策 | 方法 |
| --- | --- |
| アクセス制限 | App ServiceのIP制限で社内IPのみ許可 |
| 認証 | Entra ID SSO（未認証アクセスは全てログイン画面へリダイレクト） |
| DB接続 | パブリックアクセスをApp ServiceのIPのみに制限 |
| HTTPS | App Serviceマネージド証明書で強制 |
| シークレット | App Serviceの環境変数（アプリケーション設定）で管理 |

## 3. セットアップ手順

### 3.1 リソースグループ作成

```bash
az group create --name rg-saas-mgmt-poc --location japaneast
```

### 3.2 App Service作成

```bash
# App Service Plan
az appservice plan create \
  --name plan-saas-mgmt-poc \
  --resource-group rg-saas-mgmt-poc \
  --sku B1 \
  --is-linux

# Web App（Ruby 3.2）
az webapp create \
  --name app-saas-mgmt-poc \
  --resource-group rg-saas-mgmt-poc \
  --plan plan-saas-mgmt-poc \
  --runtime "RUBY:3.2"
```

### 3.3 PostgreSQL作成

```bash
az postgres flexible-server create \
  --name psql-saas-mgmt-poc \
  --resource-group rg-saas-mgmt-poc \
  --location japaneast \
  --sku-name Standard_B1ms \
  --storage-size 32 \
  --version 15 \
  --admin-user saasadmin \
  --admin-password <パスワード>

# データベース作成
az postgres flexible-server db create \
  --server-name psql-saas-mgmt-poc \
  --resource-group rg-saas-mgmt-poc \
  --database-name saas_management_poc
```

### 3.4 IP制限設定

```bash
# App ServiceにIP制限を追加（社内IPのみ許可）
az webapp config access-restriction add \
  --name app-saas-mgmt-poc \
  --resource-group rg-saas-mgmt-poc \
  --priority 100 \
  --rule-name "AllowOffice" \
  --action Allow \
  --ip-address <社内グローバルIP>/32
```

### 3.5 環境変数設定

```bash
az webapp config appsettings set \
  --name app-saas-mgmt-poc \
  --resource-group rg-saas-mgmt-poc \
  --settings \
    RAILS_ENV=production \
    RAILS_MASTER_KEY=<master key> \
    DATABASE_URL="postgres://saasadmin:<pw>@psql-saas-mgmt-poc.postgres.database.azure.com:5432/saas_management_poc?sslmode=require" \
    ENTRA_CLIENT_ID=<client id> \
    ENTRA_CLIENT_SECRET=<client secret> \
    ENTRA_TENANT_ID=<tenant id> \
    TEAMS_WEBHOOK_URL=<webhook url>
```

### 3.6 デプロイ

```bash
# ローカルGitデプロイ or GitHub連携
az webapp deployment source config-local-git \
  --name app-saas-mgmt-poc \
  --resource-group rg-saas-mgmt-poc

git remote add azure <デプロイURL>
git push azure main
```

## 4. 本番移行時の拡張計画

| 項目 | 追加内容 | 月額追加 |
| --- | --- | --- |
| シークレット管理 | Azure Key Vault（App Service参照） | ほぼ無料 |
| 監視 | Azure Monitor + Log Analytics | ほぼ無料 |
| ネットワーク | VNet統合（App Service↔PostgreSQL間の通信暗号化強化） | 追加なし |
| IaC | Terraform化（全リソースをコード管理） | - |
| CI/CD | GitHub Actions（plan/apply自動化） | - |
| バックアップ | PostgreSQL自動バックアップ（7日保持）※POCでもデフォルト有効 | 追加なし |
| 環境分離 | dev / prod の2環境 | 約4,500円（prod追加分） |

### 本番構成図（参考）

```
[ユーザー]
  ↓ HTTPS（IP制限 + Conditional Access Policy）
[Azure App Service] ── Rails アプリ
  ↓ VNet内部通信
[Azure Database for PostgreSQL]
  ↓
[Azure Key Vault] ── シークレット管理
[Azure Monitor] ── ログ・監視・アラート
```

### コスト比較

| 構成 | 月額 | 年額 |
| --- | --- | --- |
| POC（現状） | 約4,500円 | 約54,000円 |
| 本番（2環境） | 約10,000円 | 約120,000円 |
| **DXECO（500名・オプション込み）** | **約170,000円** | **約2,040,000円** |

---

作成日: 2026年2月10日
