# SaaSç®¡ç†ãƒ„ãƒ¼ãƒ« POC ãƒãƒƒãƒå‡¦ç†è¨­è¨ˆ

---

## 1. POCã§ã®ãƒãƒƒãƒæ–¹é‡

POCã§ã¯å®šæœŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã¯ä¸è¦ã€‚**ç®¡ç†ç”»é¢ã®ãƒœã‚¿ãƒ³ã‹ã‚‰æ‰‹å‹•å®Ÿè¡Œã§ãã‚Œã°ååˆ†ã€‚** æœ¬ç•ªç§»è¡Œæ™‚ã«Solid Queueã®recurring tasksã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã™ã‚‹ã€‚

### POCã§å®Ÿè£…ã™ã‚‹ãƒãƒƒãƒ

| # | ãƒãƒƒãƒå | å®Ÿè¡Œæ–¹å¼ | å¿…è¦æ€§ |
| --- | --- | --- | --- |
| 1 | Entra IDãƒ¦ãƒ¼ã‚¶ãƒ¼åŒæœŸ | ç®¡ç†ç”»é¢ã‹ã‚‰æ‰‹å‹•å®Ÿè¡Œ | **å¿…é ˆ**ï¼ˆé€€è·è€…æ¤œå‡ºã®ãƒ‡ãƒ¢ã«å¿…è¦ï¼‰ |
| 2 | é€€è·è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¤œå‡º | #1å®Œäº†å¾Œã«è‡ªå‹•èµ·å‹• | **å¿…é ˆ**ï¼ˆå·®åˆ¥åŒ–æ©Ÿèƒ½ã®ãƒ‡ãƒ¢ï¼‰ |
| 3 | ã‚µãƒ¼ãƒ™ã‚¤ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ | ã‚µãƒ¼ãƒ™ã‚¤é…ä¿¡å¾Œã«æ‰‹å‹• or è‡ªå‹• | é«˜ï¼ˆãƒ‡ãƒ¢ã§è¦‹ã›ãŸã„ï¼‰ |
| 4 | ã‚¿ã‚¹ã‚¯æœŸé™ãƒã‚§ãƒƒã‚¯ | æ‰‹å‹•å®Ÿè¡Œ | ä¸­ï¼ˆã‚ã‚Œã°è‰¯ã„ï¼‰ |

### POCã§ã¯å®Ÿè£…ã—ãªã„ãƒãƒƒãƒï¼ˆæœ¬ç•ªç§»è¡Œæ™‚ã«è¿½åŠ ï¼‰

| ãƒãƒƒãƒå | ç†ç”± |
| --- | --- |
| SaaSã‚¢ã‚«ã‚¦ãƒ³ãƒˆåŒæœŸï¼ˆå„SaaS APIé€£æºï¼‰ | 260ä»¶ã®å¤§åŠãŒAPIä¸å¯ã€‚POCã§ã¯CSVå–è¾¼ã§ä»£æ›¿ |
| æœªåˆ©ç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¤œå‡º | APIé€£æºãŒå‰æã€‚POCã§ã¯ã‚µãƒ¼ãƒ™ã‚¤ãƒ™ãƒ¼ã‚¹ã®æ¤œå‡ºã§ä»£æ›¿ |
| å¥‘ç´„æ›´æ–°ã‚¢ãƒ©ãƒ¼ãƒˆ | å°å¸³ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ç”»é¢ä¸Šã§ç¢ºèªå¯èƒ½ã€‚è‡ªå‹•é€šçŸ¥ã¯å¾Œå›ã— |
| æ‹…å½“è€…ä¸åœ¨æ¤œå‡º | åŒä¸Š |
| æœˆæ¬¡ã‚³ã‚¹ãƒˆé›†è¨ˆ | åŒä¸Š |
| ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæœŸé™ãƒã‚§ãƒƒã‚¯ | é‹ç”¨ãƒ•ã‚§ãƒ¼ã‚ºã®è©± |

## 2. å®Ÿè¡ŒåŸºç›¤

### 2.1 æŠ€è¡“é¸å®š

| é …ç›® | POC | æœ¬ç•ªç§»è¡Œæ™‚ |
| --- | --- | --- |
| ã‚¸ãƒ§ãƒ–å®Ÿè¡Œ | Active Job + Solid Queue | åŒå·¦ |
| ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚° | æ‰‹å‹•å®Ÿè¡Œã®ã¿ï¼ˆç®¡ç†ç”»é¢ã®ãƒœã‚¿ãƒ³ï¼‰ | Solid Queueã®recurring tasks |
| ãƒªãƒˆãƒ©ã‚¤ | åŸºæœ¬çš„ãªãƒªãƒˆãƒ©ã‚¤ï¼ˆ3å›ï¼‰ | æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ä»˜ããƒªãƒˆãƒ©ã‚¤ |
| ãƒ­ã‚° | batch_execution_logsãƒ†ãƒ¼ãƒ–ãƒ« | åŒå·¦ |

### 2.2 ç®¡ç†ç”»é¢ã®ãƒãƒƒãƒæ“ä½œï¼ˆPOCï¼‰

```
ç®¡ç†ç”»é¢ > ãƒãƒƒãƒç®¡ç†
  [Entra IDãƒ¦ãƒ¼ã‚¶ãƒ¼åŒæœŸ] [å®Ÿè¡Œ] â† ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã‚¸ãƒ§ãƒ–ãŒã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°ã•ã‚Œã‚‹
  [é€€è·è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¤œå‡º] [å®Ÿè¡Œ]
  
  å®Ÿè¡Œå±¥æ­´:
  | æ—¥æ™‚ | ãƒãƒƒãƒå | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | å‡¦ç†ä»¶æ•° | ã‚¨ãƒ©ãƒ¼ |
  | 2/10 10:00 | EntraUserSyncJob | success | 500 | 0 |
  | 2/10 10:01 | RetiredAccountDetectionJob | success | 3 | 0 |
```

## 3. Entra IDãƒ¦ãƒ¼ã‚¶ãƒ¼åŒæœŸ

**ç›®çš„:** Entra IDä¸Šã®å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã€usersãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æœ€æ–°åŒ–ã™ã‚‹ã€‚é€€è·è€…ï¼ˆaccountEnabled=falseï¼‰ã‚’æ¤œå‡ºã™ã‚‹å‰æå‡¦ç†ã€‚

### å‡¦ç†ãƒ•ãƒ­ãƒ¼

```ruby
class EntraUserSyncJob < ApplicationJob
  def perform
    log = BatchExecutionLog.create!(job_name: self.class.name, status: "running", started_at: Time.current)
    
    # 1. Graph APIã§ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ãƒ•ãƒ­ãƒ¼ï¼‰
    token = EntraClient.fetch_app_token
    
    # 2. å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
    entra_users = EntraClient.fetch_all_users(token)
    
    # 3. usersãƒ†ãƒ¼ãƒ–ãƒ«ã«upsert
    stats = { processed: 0, created: 0, updated: 0, errors: 0 }
    entra_users.each do |eu|
      user = User.find_or_initialize_by(entra_id_sub: eu["id"])
      user.assign_attributes(
        email: eu["mail"],
        display_name: eu["displayName"],
        department: eu["department"],
        job_title: eu["jobTitle"],
        employee_id: eu["employeeId"],
        account_enabled: eu["accountEnabled"]
      )
      if user.new_record?
        user.role = "viewer"
        stats[:created] += 1
      else
        stats[:updated] += 1
      end
      user.save!
      stats[:processed] += 1
    rescue => e
      stats[:errors] += 1
    end
    
    # 4. å®Œäº†è¨˜éŒ²
    log.update!(status: "success", finished_at: Time.current, **stats)
    
    # 5. é€€è·è€…æ¤œå‡ºã‚’è‡ªå‹•èµ·å‹•
    RetiredAccountDetectionJob.perform_later
  end
end
```

### Graph APIå‘¼ã³å‡ºã—

```ruby
class EntraClient
  BASE_URL = "https://graph.microsoft.com/v1.0"
  
  def self.fetch_all_users(token)
    url = "#{BASE_URL}/users?$select=id,displayName,mail,jobTitle,department,employeeId,accountEnabled&$top=999"
    users = []
    loop do
      response = Faraday.get(url) do |req|
        req.headers["Authorization"] = "Bearer #{token}"
      end
      data = JSON.parse(response.body)
      users.concat(data["value"])
      url = data["@odata.nextLink"]
      break unless url
    end
    users
  end
end
```

## 4. é€€è·è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¤œå‡º

**ç›®çš„:** Entra IDã§ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€å„SaaSã«ã¾ã ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æŒã£ã¦ã„ãªã„ã‹ã‚’æ¤œå‡ºã™ã‚‹ã€‚

### å‡¦ç†ãƒ•ãƒ­ãƒ¼

```ruby
class RetiredAccountDetectionJob < ApplicationJob
  def perform
    log = BatchExecutionLog.create!(job_name: self.class.name, status: "running", started_at: Time.current)
    
    # 1. é€€è·è€…ï¼ˆaccountEnabled = falseï¼‰ã‚’å–å¾—
    retired_users = User.where(account_enabled: false)
    
    # 2. é€€è·è€…ãŒæŒã¤activeãªSaaSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æ¤œå‡º
    results = []
    retired_users.each do |user|
      remaining_accounts = user.saas_accounts.where(status: "active").includes(:saas)
      if remaining_accounts.any?
        results << {
          user: user,
          accounts: remaining_accounts.map { |a| { saas_name: a.saas.name, email: a.account_email } }
        }
      end
    end
    
    # 3. çµæœã‚’è¨˜éŒ²
    log.update!(
      status: "success",
      finished_at: Time.current,
      processed_count: retired_users.count,
      error_count: 0,
      error_messages: results.to_json
    )
    
    # 4. Teamsé€šçŸ¥ï¼ˆæ¤œå‡ºã‚ã‚Šã®å ´åˆï¼‰
    if results.any?
      TeamsNotifier.notify(
        title: "ğŸš¨ é€€è·è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¤œå‡º: #{results.size}å",
        body: results.map { |r|
          "â–  #{r[:user].display_name}\n" +
          r[:accounts].map { |a| "  - #{a[:saas_name]}: #{a[:email]}" }.join("\n")
        }.join("\n\n"),
        level: :warning
      )
    end
  end
end
```

## 5. Teamsé€šçŸ¥ï¼ˆå…±é€šåŸºç›¤ï¼‰

```ruby
class TeamsNotifier
  # Power Automate Workflows Webhook URL
  WEBHOOK_URL = Rails.application.credentials.dig(:teams, :webhook_url)

  def self.notify(title:, body:, level: :info)
    return unless WEBHOOK_URL.present?
    
    payload = {
      type: "message",
      attachments: [{
        contentType: "application/vnd.microsoft.card.adaptive",
        content: {
          "$schema" => "http://adaptivecards.io/schemas/adaptive-card.json",
          type: "AdaptiveCard",
          version: "1.4",
          body: [
            { type: "TextBlock", text: title, weight: "Bolder", size: "Medium" },
            { type: "TextBlock", text: body, wrap: true }
          ]
        }
      }]
    }
    Faraday.post(WEBHOOK_URL, payload.to_json, "Content-Type" => "application/json")
  end
end
```

## 6. å®Ÿè¡Œå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«

```ruby
# db/migrate/xxx_create_batch_execution_logs.rb
create_table :batch_execution_logs do |t|
  t.string :job_name, null: false
  t.string :status, null: false  # running / success / failure
  t.datetime :started_at
  t.datetime :finished_at
  t.integer :processed_count, default: 0
  t.integer :created_count, default: 0
  t.integer :updated_count, default: 0
  t.integer :error_count, default: 0
  t.text :error_messages  # JSON
  t.timestamps
end
```

## 7. æœ¬ç•ªç§»è¡Œæ™‚ã®æ‹¡å¼µè¨ˆç”»

POCå®Œäº†å¾Œã€ä»¥ä¸‹ã®ãƒãƒƒãƒã‚’é †æ¬¡è¿½åŠ ã™ã‚‹ã€‚

| å„ªå…ˆåº¦ | ãƒãƒƒãƒ | è¿½åŠ å·¥æ•° |
| --- | --- | --- |
| é«˜ | å¥‘ç´„æ›´æ–°ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆæ—¥æ¬¡ï¼‰ | 0.5æ—¥ |
| é«˜ | ã‚µãƒ¼ãƒ™ã‚¤è‡ªå‹•é…ä¿¡ï¼ˆå®šæœŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰ | 0.5æ—¥ |
| ä¸­ | SaaSã‚¢ã‚«ã‚¦ãƒ³ãƒˆåŒæœŸï¼ˆGoogle / M365 / Slackï¼‰ | 1ã€œ2æ—¥ |
| ä¸­ | æœªåˆ©ç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¤œå‡ºï¼ˆæœˆæ¬¡ï¼‰ | 0.5æ—¥ |
| ä¸­ | æ‹…å½“è€…ä¸åœ¨æ¤œå‡ºï¼ˆæœˆæ¬¡ï¼‰ | 0.5æ—¥ |
| ä½ | æœˆæ¬¡ã‚³ã‚¹ãƒˆé›†è¨ˆ | 0.5æ—¥ |
| ä½ | ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæœŸé™ãƒã‚§ãƒƒã‚¯ | 0.5æ—¥ |

---

ä½œæˆæ—¥: 2026å¹´2æœˆ10æ—¥
