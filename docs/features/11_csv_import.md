# CSVインポート

## 概要
SaaS台帳とアカウント管理でCSVファイルからの一括データ登録をサポートする。手動入力の手間を削減し、既存のスプレッドシートからのデータ移行を容易にする。

## 対応画面

### SaaS台帳 CSVインポート
- **インポート**: `POST /saases/import`
- **テンプレートDL**: `GET /saases/download_template`
- **画面**: SaaS一覧画面のモーダルダイアログ（テンプレートダウンロードリンク付き）

#### CSVフォーマット（日本語ヘッダー）

| カラム | 必須 | 説明 |
|--------|------|------|
| SaaS名 | 必須 | サービス名称（空欄の場合エラー） |
| カテゴリ | 任意 | 一般IT / 不動産管理 / バックオフィス 等 |
| ステータス | 任意 | active / trial / cancelled（デフォルト: active） |
| URL | 任意 | サービスURL |
| 管理画面URL | 任意 | 管理コンソールのURL |
| 説明 | 任意 | サービスの説明 |

> **英語ヘッダー（name, category, url 等）も引き続き利用可能。** エクスポートCSVもそのまま再インポートできる。

#### エラーハンドリング

| エラー条件 | 挙動 |
|------------|------|
| ファイル未選択 | 「ファイルを選択してください」と表示。処理は実行されない |
| SaaS名が空 | 該当行をスキップし「Name can't be blank」エラーを記録 |
| SaaS名が既存と重複 | 該当行をスキップし「SaaS 'xxx' は既に存在します」エラーを記録 |
| CSV内に複数エラー | エラー行をスキップして残りの行は正常に処理。結果に先頭3件のエラー詳細を表示 |

**結果表示例:**
- 成功時: `3件のSaaSをインポートしました`
- エラーあり: `成功: 2件, エラー: 1件 (3行目: SaaS 'Slack' は既に存在します)`

### アカウント CSVインポート
- **インポート**: `POST /saas_accounts/import`
- **テンプレートDL**: `GET /saas_accounts/download_template`
- **画面**: アカウント一覧画面のモーダルダイアログ（テンプレートダウンロードリンク付き）

#### CSVフォーマット（日本語ヘッダー）

| カラム | 必須 | 説明 |
|--------|------|------|
| SaaS名 | 必須 | 対象SaaS名（既存のSaaS名で照合） |
| ユーザーメール | 必須 | 社内メールアドレス（Entra IDで同期される社内アドレス。システム内のユーザー特定に使用） |
| アカウントメール | 任意 | SaaSにログインする時のメールアドレス。社内メールと異なる場合に指定（例: 個人メールで登録したSaaS）。省略時はユーザーメールと同じとみなす |
| ロール | 任意 | member / admin / owner |
| ステータス | 任意 | active / suspended / deleted（デフォルト: active） |

> **英語ヘッダー（saas_name, user_email 等）も引き続き利用可能。** エクスポートCSVから再インポートする場合は、アカウントメール列でユーザーを照合する。

#### エラーハンドリング

| エラー条件 | 挙動 |
|------------|------|
| ファイル未選択 | 「ファイルを選択してください」と表示。処理は実行されない |
| SaaS名が存在しない | 該当行をスキップし「SaaS 'xxx' が見つかりません」エラーを記録 |
| ユーザーメールが存在しない | 該当行をスキップし「ユーザー 'xxx' が見つかりません」エラーを記録 |
| 同じSaaS＋ユーザーが既に登録済み | 該当行をスキップしバリデーションエラーを記録 |
| CSV内に複数エラー | エラー行をスキップして残りの行は正常に処理。結果に先頭3件のエラー詳細を表示 |

**結果表示例:**
- 成功時: `2件のアカウントをインポートしました`
- エラーあり: `成功: 1件, エラー: 1件 (2行目: SaaS 'Unknown' が見つかりません)`

## テンプレートCSVダウンロード

インポートモーダル内の「テンプレートをダウンロード」リンクからCSVテンプレートを取得できる。

- BOM付きUTF-8エンコーディング（Excel互換）
- ヘッダー行（日本語）+ サンプルデータ1行を含む
- **テンプレートをそのままインポート可能**（サンプルデータがそのまま登録される）

## エクスポートCSVの再インポート

エクスポートしたCSVをそのまま再インポートできる。

- エクスポートとインポートで**同じ日本語ヘッダー**を使用
- エクスポート専用の列（担当者、プラン、月額等）はインポート時に無視される
- **SaaS名の重複チェック**は有効なので、既に登録済みのデータを再インポートすると重複エラーになる

## アクセス権限
admin / manager のみインポート実行可能（`require_admin_or_manager`）。
テンプレートダウンロードはログインユーザー全員が利用可能。
