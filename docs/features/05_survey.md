# サーベイ

## 概要
SaaSアカウントの利用状況を確認するためのアンケート機能。管理者がサーベイを作成・配信し、各ユーザーがアカウントの利用有無を回答する。未利用アカウントの検出やパスワード更新の確認に活用する。

## URL
| 画面 | URL |
|------|-----|
| 一覧 | `GET /surveys` |
| 新規作成 | `GET /surveys/new` |
| 詳細 | `GET /surveys/:id` |
| 配信 | `POST /surveys/:id/activate` |
| リマインド | `POST /surveys/:id/remind` |
| クローズ | `PATCH /surveys/:id/close` |

## サーベイタイプ
| タイプ | 説明 | 回答選択肢 |
|--------|------|-----------|
| アカウント棚卸し | SaaSの利用有無を確認 | 利用中 / 利用していない |
| パスワード更新 | パスワード更新状況を確認 | 更新済み / 未対応 |

## ステータスフロー
```
draft → active → closed
（下書き） （配信中） （終了）
```

## データ項目
| 項目 | 説明 |
|------|------|
| タイトル | サーベイ名 |
| タイプ | アカウント棚卸し / パスワード更新 |
| ステータス | draft / active / closed |
| 回答率 | 回答済み / 対象件数（%） |
| 締切日 | 回答期限 |
| 作成者 | サーベイを作成した管理者 |

## 一覧画面の機能
- ステータスバッジ表示
- 回答率のパーセンテージ表示
- 新規作成ボタン（admin専用）

## 詳細画面の機能

### 管理者ビュー
- 回答率のサマリ表示
- 「利用していない」回答の件数ハイライト
- 全回答一覧テーブル（メンバー名、SaaS、回答状況、回答日時、備考）
- 配信・リマインド・クローズボタン
- **不要アカウント一覧セクション**（クローズ済みサーベイ）: 「利用していない」と回答されたアカウントを一覧表示
- **タスク生成ボタン**: 不要アカウントの削除タスクをワンクリックで生成（サーベイ → 検出 → タスク → 完了の一気通貫フロー）

### ユーザービュー
- 自分に割り当てられたアカウントの回答フォーム
- ドロップダウンで利用状況を選択
- 備考欄（任意）
- 回答済みマーク表示

## 配信・通知方法

| 方法 | 対応状況 | 説明 |
|------|:--------:|------|
| Teams Webhook | ○ | `TEAMS_WEBHOOK_SURVEY_URL` 設定時はサーベイ専用チャネルへ、未設定時は `TEAMS_WEBHOOK_URL` にフォールバック |
| アプリ内（画面） | ○ | ユーザーがログイン後、サーベイ一覧から active なサーベイを確認・回答 |
| メール通知 | ○ | SMTP設定時、配信・リマインド時に対象ユーザーへ個別メール送信（`deliver_later`） |

### 配信フロー
```
1. 管理者がサーベイ作成（draft）
   ├─ 対象の絞り込み: 部署別 / SaaS別（任意）
   └─ 対象アカウントごとに SurveyResponse レコードが自動生成

2. 管理者が「配信」ボタンをクリック（draft → active）
   └─ Teams チャネルに通知（TEAMS_WEBHOOK_URL 設定時）

3. ユーザーがアプリにログインし、画面上で回答
   ├─ 自分に割り当てられたアカウントごとにドロップダウンで選択
   ├─ 備考欄に任意コメント入力
   └─ 「保存」で回答送信（responded_at が記録される）

4. 管理者が回答率を確認、必要に応じてリマインド送信
   └─ Teams チャネルに未回答者数を含むリマインド通知

5. 締切後、管理者が「クローズ」（active → closed）
```

### 回答方式
- **画面上のフォーム入力**で回答（メール返信等ではない）
- ユーザーはサーベイ詳細画面で自分の割り当てアカウントを確認し、各アカウントについてドロップダウンから選択する
- 回答はリアルタイムで保存され、管理者ビューに即時反映される

## アクセス権限
| ロール | 権限 |
|--------|------|
| admin | 作成 + 配信 + クローズ + 全回答閲覧 |
| manager | 閲覧のみ |
| viewer | 自分の回答のみ |
