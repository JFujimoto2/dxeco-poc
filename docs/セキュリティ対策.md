# セキュリティ対策

## 概要

SaaS管理ツールはアカウント情報・契約情報・個人情報を扱うため、多層的なセキュリティ対策を実施している。

---

## 1. 認証・認可

### 1.1 認証方式

| 項目 | 内容 |
| --- | --- |
| SSO | Microsoft Entra ID (OIDC) によるシングルサインオン |
| セッション管理 | Railsのセッションクッキー（`session[:user_id]`）、サーバーサイドで管理 |
| 全画面認証必須 | `ApplicationController` で `before_action :require_login` を設定 |
| 開発環境 | `ENTRA_CLIENT_ID` 未設定時のみ開発用ログインフォームが有効化 |

### 1.2 認可（RBAC）

3段階のロールベースアクセス制御:

| ロール | 権限 |
| --- | --- |
| `admin` | 全機能にアクセス（バッチ実行、ロール変更、操作ログ閲覧、ユーザー管理） |
| `manager` | データ編集、サーベイ作成・管理、タスク管理、申請承認 |
| `viewer` | 閲覧のみ、サーベイ回答、申請作成 |

- 管理者専用機能は `before_action :require_admin` で制御
- 新規同期ユーザーはデフォルト `viewer` ロールで作成（最小権限原則）

### 1.3 Entra ID アプリ登録

| 設定 | 値 |
| --- | --- |
| サポートされるアカウント | 「この組織ディレクトリのみ」（シングルテナント） |
| リダイレクトURI | `https://<アプリURL>/auth/entra_id/callback` のみ |
| API許可 | `User.Read.All`, `GroupMember.Read.All`, `Application.Read.All`（アプリケーション許可） |
| クライアントシークレット | 環境変数で管理（ソースコードに含めない） |

---

## 2. 通信の暗号化

### 2.1 HTTPS

| 区間 | 方式 |
| --- | --- |
| ユーザー ↔ Container Apps | HTTPS強制（Azure Managed Certificate による SSL/TLS） |
| Container Apps ↔ PostgreSQL | SSL接続必須（`sslmode=require`） |
| Container Apps ↔ Entra ID | HTTPS（Microsoft Graph API） |
| Container Apps ↔ Teams | HTTPS（Power Automate Webhook） |

- HTTPアクセスは自動的にHTTPSへリダイレクト
- SSL証明書は Azure が自動更新（手動管理不要）

### 2.2 Railsセキュリティヘッダー

Rails 8 のデフォルト設定により以下のヘッダーが自動適用:

- `X-Frame-Options: SAMEORIGIN`（クリックジャッキング対策）
- `X-Content-Type-Options: nosniff`（MIMEスニッフィング対策）
- `X-XSS-Protection: 0`（ブラウザのXSSフィルタ無効化、CSP推奨）
- `Referrer-Policy: strict-origin-when-cross-origin`

---

## 3. インフラセキュリティ

### 3.1 Azure Container Apps

| 項目 | 対策 |
| --- | --- |
| コンテナ実行ユーザー | non-root（uid 1000）で実行 |
| レプリカ数 | min 0 ～ max 1（スケール制限） |
| イングレス | HTTPS のみ許可 |
| 環境変数 | Container Apps の環境変数で秘密情報管理（ソースコードに含めない） |
| コンテナイメージ | プライベート ACR（Azure Container Registry）からプル |

### 3.2 PostgreSQL

| 項目 | 対策 |
| --- | --- |
| ファイアウォール | IP制限（許可されたIPアドレスのみ接続可） |
| SSL接続 | 必須（`sslmode=require`） |
| 認証 | SCRAM-SHA-256 パスワード認証 |
| バックアップ | Azure自動バックアップ（7日間保持） |
| パブリックアクセス | ファイアウォールルールで制御（デフォルト拒否） |

### 3.3 ネットワーク

| 項目 | 対策 |
| --- | --- |
| 外部アクセス | Container Apps のイングレス経由のみ |
| DB接続 | Container Apps Environment 内からのみ（+ ファイアウォール許可IP） |
| ACR | Container Apps からのプライベート接続 |

---

## 4. アプリケーションセキュリティ

### 4.1 CSRF対策

- Rails標準の `protect_from_forgery with: :exception` が有効
- 全フォームに CSRF トークンが自動挿入

### 4.2 SQLインジェクション対策

- Active Record の parameterized queries を使用
- 生SQL不使用（全てActive Recordのクエリインタフェース経由）
- Brakeman による静的解析で検出（CI で毎回実行）

### 4.3 XSS対策

- ERBテンプレートのデフォルトエスケープ（`<%= %>` は自動HTMLエスケープ）
- `raw` / `html_safe` の使用を最小限に制限
- Content Security Policy は Rails のデフォルト設定

### 4.4 マスアサインメント対策

- Strong Parameters (`permit`) で受け入れるパラメータを明示的に制限
- Brakeman でマスアサインメント脆弱性を静的解析

### 4.5 依存関係のセキュリティ

| ツール | 対象 | 実行タイミング |
| --- | --- | --- |
| `bundler-audit` | Ruby gems の既知脆弱性 | CI 毎回 (scan_ruby ジョブ) |
| `importmap audit` | JavaScript パッケージの脆弱性 | CI 毎回 (scan_js ジョブ) |
| Dependabot | 依存パッケージの自動更新PR | GitHub が自動実行 |

---

## 5. 監査・ログ

### 5.1 操作ログ（Auditable concern）

全主要モデルの CRUD 操作を自動記録:

| 記録項目 | 内容 |
| --- | --- |
| 操作者 | `Current.user`（ログイン中のユーザー） |
| IPアドレス | `Current.ip_address`（リクエスト元IP） |
| 操作種別 | create / update / destroy |
| 対象リソース | モデル名 + ID |
| 変更差分 | 変更前後の値を JSONB で記録 |
| タイムスタンプ | 操作日時 |

- 操作ログは管理者のみ閲覧可能
- CSV エクスポート対応（監査対応）

### 5.2 バッチ実行ログ

全バッチ処理の実行記録:

- ジョブ名、開始/終了時刻、ステータス（成功/失敗）
- 処理件数、作成件数、更新件数、エラー件数
- エラー詳細（失敗時）

---

## 6. エラー監視・アラート

### 6.1 アプリケーション層

| 項目 | 内容 |
| --- | --- |
| ErrorSubscriber | Rails ErrorReporter でアプリケーションエラーをキャプチャ |
| Teams通知 | エラー発生時に即座にTeamsのエラー専用チャンネルに通知 |
| スロットリング | 同一エラーは5分間に1回のみ通知（重複防止） |
| 通知内容 | エラークラス、メッセージ、コントローラー、ユーザー、バックトレース |

### 6.2 インフラ層

| 項目 | 内容 |
| --- | --- |
| Azure Monitor | コンテナ再起動を検知するメトリックアラート |
| Action Group | アラート発火時にTeams Webhookへ通知 |

---

## 7. CI/CD セキュリティ

### 7.1 CI パイプライン（全PRで自動実行）

| チェック | ツール | 内容 |
| --- | --- | --- |
| 静的解析（セキュリティ） | Brakeman | Rails特有の脆弱性検出（SQLi, XSS, CSRF等） |
| Gem脆弱性チェック | bundler-audit | 既知のCVE検出 |
| JS脆弱性チェック | importmap audit | JavaScript依存の脆弱性検出 |
| コードスタイル | Rubocop | セキュリティに関連するコーディング規約 |
| テスト | RSpec (291件) | ユニット・リクエストテスト |
| E2Eテスト | Playwright (73件) | ブラウザ経由のエンドツーエンドテスト |

### 7.2 CD パイプライン

| 項目 | 対策 |
| --- | --- |
| 認証 | Service Principal + OIDC（シークレットレス） |
| イメージタグ | Git SHA でイミュータブルタグ付け |
| レジストリ | プライベート ACR（パブリックアクセス不可） |
| デプロイ | `prod` ブランチへのPRマージでのみ自動デプロイ |

### 7.3 ブランチ保護

| ブランチ | ルール |
| --- | --- |
| `main` | PR必須、CI 5ジョブ全パス必須、直接push不可 |
| `prod` | PR必須、CI 5ジョブ全パス必須、直接push不可 |

---

## 8. 秘密情報の管理

### 8.1 管理方針

| 環境 | 管理方法 |
| --- | --- |
| 開発環境 | `.env` ファイル（gitignore済み） |
| CI環境 | GitHub Secrets |
| 本番環境 | Azure Container Apps 環境変数 |

### 8.2 管理対象の秘密情報

| 変数 | 用途 |
| --- | --- |
| `ENTRA_CLIENT_ID` | Entra ID アプリクライアントID |
| `ENTRA_CLIENT_SECRET` | Entra ID クライアントシークレット |
| `ENTRA_TENANT_ID` | Entra ID テナントID |
| `SECRET_KEY_BASE` | Rails セッション暗号化キー |
| `DATABASE_URL` | PostgreSQL 接続文字列 |
| `TEAMS_WEBHOOK_URL` | Teams通知Webhook（一般） |
| `TEAMS_WEBHOOK_SURVEY_URL` | Teams通知Webhook（サーベイ） |
| `TEAMS_WEBHOOK_ERROR_URL` | Teams通知Webhook（エラー） |
| `SMTP_PASSWORD` | メール送信用SMTPパスワード |

### 8.3 ソースコード上のルール

- `.env` は `.gitignore` に登録済み
- `infra/DB接続情報.md` は `.gitignore` に登録済み
- `.env.example` には値を含めない（キー名のみ）
- ハードコードされた秘密情報は Brakeman が検出

---

## 9. 今後の対策（本番移行時に検討）

| 対策 | 内容 | 優先度 |
| --- | --- | --- |
| Azure Key Vault | 秘密情報の集中管理（Container Apps環境変数からの移行） | 中 |
| WAF | Azure Front Door + WAF によるアプリケーション層防御 | 中 |
| VNet統合 | Container Apps と PostgreSQL をVNet内に閉じる | 高 |
| ログ集約 | Azure Log Analytics によるアクセスログ・エラーログの集約分析 | 中 |
| セッションタイムアウト | 無操作時の自動ログアウト（現在はセッションCookie有効期限に依存） | 低 |
| 多要素認証強制 | Entra ID条件付きアクセスポリシーでMFA必須化 | 中 |
| データ暗号化 | PostgreSQL の保存時暗号化（Azure標準で有効、追加対策はTDE） | 低 |
| 脆弱性診断 | 外部ペネトレーションテスト実施 | 本番前 |

---

作成日: 2026年2月15日
