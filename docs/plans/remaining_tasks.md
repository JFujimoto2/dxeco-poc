# POC 残タスク一覧

## 概要

DXECOとの比較分析を踏まえ、POCの説得力を高めるために追加すべき機能と、運用本番化に向けた課題を整理する。

---

## 0. バグ修正・改善（完了済み）

### 0.1 CSVインポート修正 & テンプレートダウンロード ✅

- [x] Turbo競合修正（`data: { turbo: false }` でフォーム送信が動作するように）
- [x] アクセス制御追加（`require_admin_or_manager` — admin/managerのみ）
- [x] CSVテンプレートダウンロード機能（BOM付きUTF-8、サンプル行付き）
- [x] インポートモーダルにテンプレートDLリンク追加
- [x] RSpecリクエストスペック追加（import + download_template + 権限テスト）
- [x] Playwright E2Eテスト追加（`e2e/csv-import.spec.ts` — 5テスト）
- [x] Bootstrap/Popper.js をCDN配信に変更（ESMサブモジュール問題を解消）

---

## 1. 追加機能（デモ強化）

### 1.1 契約更新アラート ✅

- [x] ダッシュボードに「更新期限が近い契約」カードを追加（30日以内）
- [x] 期限30日前・7日前にTeams通知を送信（ContractRenewalAlertJob）
- [x] 期限切れ契約の件数表示
- [x] バッチ管理画面に手動実行ボタン追加
- [x] seedデータにデモ用の期限設定（7日以内・30日以内・期限切れ）
- [x] RSpecテスト作成（モデル5件 + ダッシュボード3件 + ジョブ3件 + バッチ1件）
- [x] Playwright E2Eテスト追加（`e2e/contract-alert.spec.ts` — 3テスト）

**根拠:** `saas_contracts.expires_on` が既にあり、通知基盤（TeamsNotifier）も整備済み。DXECOにもある機能なので「同等以上」と言いやすい。

### 1.2 サーベイ → タスク連携 ✅

- [x] サーベイ結果画面に「不要アカウント一覧」セクションを追加
- [x] 「利用していない」回答から削除タスクをワンクリック生成
- [x] サーベイ → 検出 → タスク → 完了の一気通貫フローを実現
- [x] RSpecテスト作成（リクエスト4件）
- [x] Playwright E2Eテスト追加（`e2e/survey-task.spec.ts` — 2テスト）

**詳細計画:** `docs/plans/survey_task_integration.md`

**根拠:** 既存のサーベイ機能とタスク管理機能を接続するだけ。デモで「検出から対応まで一画面で完結」を見せられる。

### 1.3 Entra ID SaaSアカウント自動同期 + パスワード期限検出 ✅

- [x] Graph API でエンタープライズアプリのユーザー割り当て一覧を取得
- [x] EntraAccountSyncJob: SaaSアカウント台帳との差分同期（新規・削除検出）
- [x] パスワード期限切れ / 期限間近のユーザー検出（`lastPasswordChangeDateTime`）
- [x] ダッシュボードにパスワード期限アラート表示
- [x] バッチ管理画面に手動実行ボタン追加
- [x] 同期結果の Teams 通知
- [x] RSpecテスト作成（EntraClient 3件 + Job 7件 + User 3件 + Dashboard 3件 + Batch 1件 + UserSync 1件 = 18件）
- [x] Playwright E2Eテスト追加（`e2e/entra-account-sync.spec.ts` — 2テスト）

**詳細計画:** `docs/plans/entra_account_sync.md`
**GitHub Issue:** [#10](https://github.com/JFujimoto2/dxeco-poc/issues/10)

**根拠:** SSO連携済みSaaSのアカウントは Graph API で自動取得可能。手動管理からの脱却を実証できる。パスワード期限管理も Graph API から取得でき、セキュリティ面の訴求力が高い。

### 1.4 コスト可視化 ✅

- [x] ダッシュボードに月額/年額コスト合計を表示
- [x] カテゴリ別コスト内訳（doughnut chart）
- [x] Chart.js をimportmapで導入
- [x] Stimulus コントローラー（cost_chart_controller.js）作成
- [x] RSpecテスト作成（モデル6件 + ダッシュボード3件 = 9件）
- [x] Playwright E2Eテスト追加（`e2e/cost-visualization.spec.ts` — 2テスト）

**詳細計画:** `docs/plans/cost_visualization.md`
**GitHub Issue:** [#6](https://github.com/JFujimoto2/dxeco-poc/issues/6)

**根拠:** `saas_contracts.price_cents` が既にある。経営層へのデモで「260件のSaaSに年間いくら払っているか」が一目で見えると効果的。

### 1.5 CSVエクスポート ✅

- [x] SaaS台帳のCSVエクスポート（フィルタ連動）
- [x] アカウント一覧のCSVエクスポート（フィルタ連動）
- [x] 監査ログのCSVエクスポート（フィルタ連動、admin権限）
- [x] RSpecテスト作成（6件）
- [x] Playwright E2Eテスト追加（`e2e/csv-export.spec.ts` — 3テスト）

**詳細計画:** `docs/plans/csv_export.md`
**GitHub Issue:** [#7](https://github.com/JFujimoto2/dxeco-poc/issues/7)

**根拠:** インポートは既にあるがエクスポートがない。監査対応・経営報告で「データを出せる」のは実用上重要。

---

## 1.6 エラー監視・アラート通知 ✅（アプリ層完了）

- [x] `ErrorSubscriber` クラス作成（Rails ErrorReporter 連携）
- [x] `TeamsNotifier.notify_error` メソッド追加
- [x] スロットリング（同一エラー5分間デバウンス）
- [x] RSpecテスト作成（6件）
- [x] 計画書作成: `docs/plans/error_monitoring.md`
- [ ] 本番環境変数に `TEAMS_WEBHOOK_ERROR_URL` 設定
- [ ] Azure Monitor Action Group / コンテナ再起動アラート作成（インフラ層、本番移行時）

**詳細計画:** `docs/plans/error_monitoring.md`

### 1.7 SaaSセキュリティ管理機能 ✅

- [x] SaaS台帳にセキュリティ属性追加（個人情報取扱い、認証方式、データ保存先）
- [x] ダッシュボードにセキュリティリスクカード追加（SSO未適用・海外データ保存・部門別リスク）
- [x] SaaS一覧に認証方式・データ保存先・部署フィルター追加
- [x] アカウント管理に部署フィルター追加
- [x] CSVインポート/エクスポートにセキュリティ属性対応
- [x] RSpecテスト作成（335件全パス、Line 95.7% / Branch 79.0%）
- [x] Playwright E2Eテスト追加（79件全パス）

**詳細計画:** `docs/plans/saas_security_management.md`
**GitHub Issue:** [#17](https://github.com/JFujimoto2/dxeco-poc/issues/17)

### 1.8 メール通知機能（未着手）

- [ ] Action Mailer + letter_opener(dev) + SMTP(prod)
- [ ] TaskMailer / ApprovalRequestMailer / SurveyMailer
- [ ] deliver_later（Solid Queue）
- [ ] 計画書: `docs/plans/email_notification.md`

**GitHub Issue:** [#9](https://github.com/JFujimoto2/dxeco-poc/issues/9)

### 1.9 OWASP ZAP 脆弱性診断（未着手）

- [ ] Docker で Baseline Scan 実行（ローカル）
- [ ] 認証付きスキャン（dev_login 利用）
- [ ] CI/CD に scan_dast ジョブ追加
- [ ] 計画書: `docs/plans/owasp_zap_scan.md`

**GitHub Issue:** [#16](https://github.com/JFujimoto2/dxeco-poc/issues/16)

---

## 2. 運用本番化に向けた課題

### 2.1 保守コストの見通し ✅

テストカバレッジ（RSpec 335件 + Playwright E2E 79件）とCI自動化が整備済みのため、日常的な保守コストは低い想定。

#### コードベースの規模

| 指標 | 値 |
|------|-----|
| アプリケーションコード | ~4,200行（99ファイル） |
| テストコード | ~3,700行（69ファイル） |
| テスト/コード比 | 0.89 |
| テストカバレッジ | Line 95.7% / Branch 79.0% |
| DBテーブル数 | 13 |
| 本番gem数 | 11（トランジティブ含め ~150） |

#### 年間保守工数の見積もり

| 作業 | 頻度 | 工数/回 | 年間合計 |
|------|------|---------|---------|
| gem セキュリティパッチ | 2-4回/年 | 1-2h | ~6h |
| Ruby パッチリリース | 3-4回/年 | 1h | ~4h |
| Rails パッチ/マイナー | 2-4回/年 | 2-4h | ~8h |
| 依存関係監査（bundler-audit） | 4回/年 | 2h | ~8h |
| CI/CDメンテナンス | 随時 | 1-2h | ~4h |
| 軽微な機能改修・要望対応 | 随時 | - | ~20h |
| **合計** | | | **~50h/年** |

**年間 約50時間（≒1人週）** で維持可能と見込む。

#### 保守コストが低い理由

1. **高テストカバレッジ（95.7%）** — リグレッションリスクが低く、安全にアップデート可能
2. **Solid Stack（Cache/Queue/Cable）** — Redis不要でインフラ構成がシンプル
3. **本番gem 11個のみ** — 依存アップデートの影響範囲が小さい
4. **Rails 8 + Kamal** — デプロイが標準化されており、バージョンアップパスも明確
5. **CI 5ジョブ自動実行（~7分）** — Rubocop + Brakeman + RSpec + Playwright で品質を自動担保

#### DXECOとのコスト比較

| 項目 | DXECO | 自社開発ツール |
|------|-------|---------------|
| 年間ライセンス | 204万円 | 0円 |
| 年間保守工数 | 0h（SaaS） | ~50h（エンジニア1人週） |
| 保守人件費目安 | - | ~25万円（@5,000円/h） |
| **年間合計** | **204万円** | **~25万円** |
| カスタマイズ性 | 低（ベンダー依存） | 高（自由に改修可能） |

#### リスクと対策

| リスク | 可能性 | 影響 | 対策 |
|--------|--------|------|------|
| Entra ID Graph API の破壊的変更 | 低 | 中 | バージョン指定 `/v1.0` を使用。リリースノート監視 |
| Rails メジャーアップグレード（8→9） | 中 | 中 | 高テストカバレッジで安全に移行可能 |
| Solid Queue のスケーリング | 低 | 中 | 単一サーバーで十分。必要時にジョブワーカー分離可能 |
| 担当者の異動・退職 | 中 | 高 | CLAUDE.md + ドキュメント整備済み。Rails標準に準拠しているため引き継ぎ容易 |
| Entra ID シークレット失効 | 中 | 高 | 有効期限を24ヶ月以内に設定。更新手順をドキュメント化済み |

### 2.2 承認フローの改修（本番移行時に必要）

現在は「申請 → 承認/却下」の1段階のみ。実運用に合わせて以下の対応が必要になる見込み。

- [ ] 会社の承認ルート（部門長→情シス等）に合わせた多段階承認
- [ ] 部門別・金額別の承認ルーティング
- [ ] 承認者の自動割り当てルール
- [ ] 承認期限・エスカレーション

※ 実際の運用フローを確認してから設計する

### 2.3 パイロット運用（WEBチーム）

- [ ] WEBチームで2〜4週間の実運用テスト
- [ ] 棚卸しサーベイを実際に回す
- [ ] 退職者アカウントの自動検出を実運用
- [ ] 成果を数字で記録（退職者アカウント件数、棚卸し工数削減率、未利用アカウント件数）

**GitHub Issue:** [#18](https://github.com/JFujimoto2/dxeco-poc/issues/18)
**前提:** SaaSセキュリティ管理機能の実装完了 + 現場課長へのデモ完了・合意

### 2.4 全社展開・開発チーム構築

- [ ] 全社のSaaSデータを投入
- [ ] 他部署への横展開（定例会議でデモ）
- [ ] デジタル推進部を味方に（セキュリティ管理機能を強調）
- [ ] 業務委託 or 副担当を入れて属人化リスクを解消

**GitHub Issue:** [#19](https://github.com/JFujimoto2/dxeco-poc/issues/19)
**前提:** パイロット運用で具体的な成果が出ていること

### 2.5 未実装のDXECO機能（本番移行時に要検討）

| 機能 | 必要性 | 備考 |
|------|--------|------|
| シャドーIT管理（ブラウザ拡張） | 低 | 精度に課題あり。導入ハードルも高い |
| IT資産管理（PC・携帯） | 低 | SaaS管理と別ツールでも可 |
| 新規アカウント検知 | 中 | Entra ID同期の拡張で対応可能 |
| Zapier連携 | 低 | 現時点では不要 |

### 2.4 リファクタリング ✅

テストカバレッジ計測（SimpleCov）とソースコード解析の結果、17項目のリファクタリング候補を特定し、14項目を完了。

**テストカバレッジ:** Line 91.2% → **95.7%** / Branch 70.7% → **79.0%**
**RSpec:** 253件 → **335件**

| カテゴリ | 項目数 | 概要 | 状態 |
|----------|--------|------|------|
| A. コード重複解消 | 4 | CSVエクスポート共通化、インポート基底クラス、パーシャル統合 | Done |
| B. パフォーマンス改善 | 3 | ダッシュボードクエリ最適化、N+1解消、インデックス（既存で充足） | Done |
| C. 責務分離 | 3 | フィルタスコープ化（C1/C2はPOC規模では過剰のためSkip） | Done |
| D. テストカバレッジ向上 | 4 | 低カバレッジファイルのテスト拡充（59.5%→90%+） | Done |
| E. セキュリティ・堅牢性 | 3 | トランザクション追加、マジックストリング定数化、エラーログ改善 | Done |

**詳細計画:** `docs/plans/refactoring.md`

---

## 3. 進め方

1. ~~**0.1 CSVインポート修正** を最優先で対応~~ ✅ 完了
2. ~~**1.1 契約更新アラート**~~ ✅ 完了 + ~~**1.2 サーベイ→タスク連携**~~ ✅ 完了
3. ~~**1.3 Entra ID SaaSアカウント自動同期 + パスワード期限検出**~~ ✅ 完了
4. ~~**1.4 コスト可視化**~~ ✅ 完了
5. ~~**1.5 CSVエクスポート**~~ ✅ 完了
6. ~~**2.4 リファクタリング**~~ ✅ 完了（14/17項目、Line 95.5% / Branch 77.9%）
7. ~~**1.7 SaaSセキュリティ管理機能**~~ ✅ 完了（RSpec 335件 + E2E 79件）
8. ~~**1.6 エラー監視・アラート通知**~~ ✅ アプリ層完了（インフラ層は本番移行時）
9. **1.8 メール通知機能**
10. **1.9 OWASP ZAP 脆弱性診断**
11. **2.3 パイロット運用** → **2.4 全社展開**

---

作成日: 2026年2月11日
更新日: 2026年2月16日（セキュリティ管理機能✅完了、テスト数・カバレッジ更新）
