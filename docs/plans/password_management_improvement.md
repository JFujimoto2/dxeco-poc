# パスワード管理の改修計画

## 現状の課題

現在のパスワード期限アラートは **Entra IDアカウントの `lastPasswordChangeDateTime`** に基づいている。

| 問題 | 詳細 |
|------|------|
| 対象が不明確 | 「パスワード期限切れ」が表示されても、どのSaaSのパスワードを更新すべきかわからない |
| SSO対象外が追跡できない | SSO未対応のSaaSは個別にパスワード管理が必要だが、現在は追跡できていない |
| SaaSごとのポリシー差異 | SaaSによってパスワード更新間隔が異なる（30日/90日/180日/無期限） |

## ベストプラクティス

SaaS管理におけるパスワード管理は以下の2軸で考える。

### 1. SSO連携 vs 個別パスワード

| 認証方式 | パスワード管理 | 対応方針 |
|----------|---------------|----------|
| **SSO連携済み（Entra ID）** | Entra IDのパスワードポリシーに従う | SaaS個別のPW管理は不要。Entra ID側で一元管理 |
| **個別パスワード** | SaaSごとに個別管理が必要 | 本ツールで更新日を追跡し、期限アラートを出す |

### 2. SaaSレベルのパスワードポリシー

SaaS台帳にパスワードポリシー情報を持たせ、アカウント単位で更新日を追跡する。

---

## 改修内容

### Phase 1: データモデル拡張

#### SaaS台帳に追加

| カラム | 型 | 説明 |
|--------|----|------|
| `auth_method` | string (enum) | `sso` / `password` / `both` — 認証方式 |
| `password_expiry_days` | integer (nullable) | PW更新間隔（日数）。null=ポリシーなし |

#### SaaSアカウントに追加

| カラム | 型 | 説明 |
|--------|----|------|
| `last_password_changed_at` | datetime (nullable) | 最終PW更新日 |

### Phase 2: ダッシュボードアラート変更

現在の「Entra IDパスワード期限」アラートを以下に置き換える:

**SaaSパスワード更新アラート**
- `auth_method` が `password` or `both` のSaaSのみ対象
- `password_expiry_days` が設定されたSaaSのアカウントを監視
- `last_password_changed_at` + `password_expiry_days` を超過 → 期限切れ
- 14日前から「期限間近」表示

**表示項目:**

| 列 | 内容 |
|----|------|
| ユーザー名 | アカウント所有者 |
| SaaS名 | どのSaaSのパスワードか（ここが現状の課題を解決） |
| 最終PW更新日 | いつ更新したか |
| 状態 | 期限切れ / 残りN日 |

### Phase 3: PW更新日の記録方法

更新日を記録する手段は3つ。併用可能。

| 方法 | 説明 | 用途 |
|------|------|------|
| **PW更新サーベイ** | 既存のサーベイ機能で「PW更新しましたか？」を配信。回答「更新済み」で `last_password_changed_at` を自動更新 | 定期的な一斉確認 |
| **手動更新** | アカウント管理画面から管理者が手動で日付を記録 | 個別対応 |
| **CSVインポート** | アカウントCSVに `最終PW更新日` 列を追加 | 一括更新 |

### Phase 4: Entra IDパスワードの扱い

- `User.last_password_change_at`（Entra ID由来）は引き続きEntra同期で取得
- SSO連携SaaSのアカウントについては、Entra IDのPW更新日をそのまま利用
- ダッシュボードではSSO/非SSOを区別して表示

---

## 画面イメージ

### ダッシュボード（改修後）

```
┌─────────────────────────────────────────────────┐
│ 🔐 SaaSパスワード更新アラート                        │
├─────────────────────────────────────────────────┤
│ ⚠ パスワード更新が必要なアカウントが 5件 あります       │
│                                                 │
│ ユーザー名     SaaS名        最終更新日  状態     │
│ 田中 太郎     ATBB          2025/09/01  期限切れ  │
│ 鈴木 花子     1Password     2025/11/20  残り5日   │
│ 佐藤 一郎     Salesforce    2025/11/25  残り10日  │
│ ...                                             │
└─────────────────────────────────────────────────┘
```

### SaaS台帳（追加フィールド）

```
認証方式:        [SSO ▼]  ← sso / password / both
PW更新間隔（日）: [90    ]  ← null なら「ポリシーなし」
```

---

## 実装順序

| # | 作業 | 見積 |
|---|------|------|
| 1 | DB マイグレーション（saases に `auth_method`, `password_expiry_days` / saas_accounts に `last_password_changed_at` 追加） | 0.5日 |
| 2 | SaaS台帳のCRUDに認証方式・PW更新間隔フィールドを追加 | 0.5日 |
| 3 | アカウント管理に最終PW更新日フィールドを追加（手動更新・CSV対応） | 0.5日 |
| 4 | ダッシュボードのアラートをSaaSアカウントベースに変更 | 0.5日 |
| 5 | PW更新サーベイの回答時に `last_password_changed_at` を自動更新 | 0.5日 |
| 6 | テスト・ドキュメント更新 | 0.5日 |

**合計: 約3日**

## 備考

- 現在のEntra IDパスワード期限の機能（`User.password_expired` / `password_expiring_soon`）はPhase 4完了後に削除可能
- 既存の260件のSaaSに `auth_method` / `password_expiry_days` をどう初期設定するかは運用チームと要相談
  - SSO対応SaaS → `sso` に設定（Entra IDエンタープライズアプリに登録済みのもの）
  - その他 → `password` に設定、`password_expiry_days` は各SaaSのポリシーに合わせて設定

---

作成日: 2026年2月15日
ステータス: **計画中（未着手）**
