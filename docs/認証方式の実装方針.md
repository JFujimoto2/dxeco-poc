# SaaS管理ツール POC 認証方式の実装方針

---

## 1. 方針概要

| 項目 | 内容 |
| --- | --- |
| 認証方式 | Microsoft Entra ID（旧Azure AD）によるSSO |
| プロトコル | OpenID Connect (OIDC) |
| ライセンス | Microsoft 365 E5（契約済み）で対応可能。追加費用なし |
| Rails側の実装 | OmniAuth + omniauth-openid-connect gem |
| ユーザー情報取得 | ログイン時にGraph APIから自動取得＋usersテーブル更新 |
| POCでの位置づけ | 最初に実装する基盤機能。これが動かないと他の全機能が使えない |

## 2. 全体フロー

```
ユーザー
  ↓ ログインボタン押下
Rails（OmniAuth）
  ↓ Entra IDへリダイレクト
Entra ID（OIDC認証画面）
  ↓ 認証成功 → IDトークン + アクセストークン返却
Rails（コールバック）
  ↓ IDトークンからユーザー識別
  ↓ アクセストークンでGraph API呼び出し → ユーザー情報取得
  ↓ DBにユーザー作成 or 更新
ログイン完了（ダッシュボードへリダイレクト）
```

## 3. Entra ID側のセットアップ

### 3.1 アプリ登録（App Registration）

Entra ID管理センター（entra.microsoft.com）で以下を設定する。

| 設定項目 | 値 |
| --- | --- |
| 名前 | SaaS管理ツール（任意） |
| サポートされるアカウントの種類 | この組織ディレクトリのみ（シングルテナント） |
| リダイレクトURI | `https://<アプリURL>/auth/entra_id/callback` |
| フロントチャネルログアウトURL | `https://<アプリURL>/logout` |

### 3.2 クライアントシークレットの発行

「証明書とシークレット」→「新しいクライアントシークレット」で発行。有効期限は最大24ヶ月。

### 3.3 APIのアクセス許可

| 権限 | 種類 | 用途 |
| --- | --- | --- |
| `openid` | 委任 | OIDC認証（必須） |
| `profile` | 委任 | 基本プロフィール取得 |
| `email` | 委任 | メールアドレス取得 |
| `User.Read` | 委任 | ログインユーザー自身の情報取得 |
| `User.Read.All` | アプリケーション | 全ユーザーの情報取得（退職者検出バッチ用） |

`User.Read.All`はテナント管理者の同意（Admin Consent）が必要。

## 4. ログイン時に取得する情報

### 4.1 IDトークンから直接取得

| クレーム | 内容 |
| --- | --- |
| `sub` | ユーザー固有ID（Entra ID内で一意） |
| `name` | 表示名 |
| `email` | メールアドレス |
| `preferred_username` | UPN（user@domain.com） |

### 4.2 Graph APIで追加取得

IDトークンだけでは部門・役職等が取れないため、Graph APIで補完する。

**エンドポイント:** `GET https://graph.microsoft.com/v1.0/me?$select=...`

| 属性 | Graph APIプロパティ | ツールでの用途 |
| --- | --- | --- |
| 表示名 | `displayName` | ユーザー表示 |
| メールアドレス | `mail` | 通知送信・識別 |
| 役職 | `jobTitle` | 権限判断・表示 |
| 部門 | `department` | 部門別フィルタ・コスト集計 |
| 社員番号 | `employeeId` | 人事データとの突合せ |
| アカウント有効/無効 | `accountEnabled` | 退職者検出 |

## 5. Rails側の実装

### 5.1 使用gem

```ruby
# Gemfile
gem 'omniauth'
gem 'omniauth-openid-connect'
gem 'omniauth-rails_csrf_protection'
```

### 5.2 OmniAuth設定

```ruby
# config/initializers/omniauth.rb
Rails.application.config.middleware.use OmniAuth::Builder do
  provider :openid_connect,
    name: :entra_id,
    scope: [:openid, :profile, :email],
    issuer: "https://login.microsoftonline.com/#{ENV['ENTRA_TENANT_ID']}/v2.0",
    client_options: {
      identifier: ENV['ENTRA_CLIENT_ID'],
      secret: ENV['ENTRA_CLIENT_SECRET'],
      redirect_uri: "#{ENV['APP_URL']}/auth/entra_id/callback"
    }
end
```

### 5.3 コールバック処理

```ruby
# app/controllers/sessions_controller.rb
class SessionsController < ApplicationController
  skip_before_action :require_login, only: [:create, :failure]

  def create
    auth = request.env['omniauth.auth']
    
    # Graph APIでユーザー情報を補完
    token = auth.credentials.token
    graph_info = fetch_graph_profile(token)
    
    # usersテーブルにupsert
    user = User.find_or_initialize_by(entra_id_sub: auth.uid)
    user.assign_attributes(
      email: auth.info.email,
      display_name: graph_info["displayName"],
      department: graph_info["department"],
      job_title: graph_info["jobTitle"],
      employee_id: graph_info["employeeId"],
      account_enabled: graph_info["accountEnabled"],
      last_signed_in_at: Time.current
    )
    user.role ||= "viewer"  # 初回ログイン時はviewer
    user.save!
    
    session[:user_id] = user.id
    redirect_to root_path
  end

  def destroy
    reset_session
    redirect_to "https://login.microsoftonline.com/#{ENV['ENTRA_TENANT_ID']}/oauth2/v2.0/logout"
  end

  private

  def fetch_graph_profile(token)
    response = Faraday.get("https://graph.microsoft.com/v1.0/me?$select=displayName,mail,jobTitle,department,employeeId,accountEnabled") do |req|
      req.headers["Authorization"] = "Bearer #{token}"
    end
    JSON.parse(response.body)
  end
end
```

### 5.4 認証フィルタ

```ruby
# app/controllers/application_controller.rb
class ApplicationController < ActionController::Base
  before_action :require_login

  private

  def require_login
    unless current_user
      redirect_to "/auth/entra_id"
    end
  end

  def current_user
    @current_user ||= User.find_by(id: session[:user_id])
  end
  helper_method :current_user

  def require_admin
    unless current_user&.admin?
    redirect_to root_path, alert: "管理者権限が必要です"
    end
  end
end
```

### 5.5 usersテーブル

```ruby
# db/migrate/xxx_create_users.rb
create_table :users do |t|
  t.string :entra_id_sub, null: false, index: { unique: true }
  t.string :email, null: false
  t.string :display_name
  t.string :department
  t.string :job_title
  t.string :employee_id
  t.boolean :account_enabled, default: true
  t.string :role, default: "viewer"  # admin / manager / viewer
  t.datetime :last_signed_in_at
  t.timestamps
end
```

### 5.6 権限管理（POCシンプル版）

```ruby
# app/models/user.rb
class User < ApplicationRecord
  enum :role, { viewer: "viewer", manager: "manager", admin: "admin" }
  
  has_many :saas_accounts
  has_many :saases, through: :saas_accounts
  
  def can_edit?(resource)
    admin? || (manager? && resource_in_scope?(resource))
  end

  private

  def resource_in_scope?(resource)
    # managerは自部門のリソースのみ編集可
    resource.respond_to?(:department) && resource.department == department
  end
end
```

## 6. セキュリティ上の注意事項

| 項目 | POCでの対応 | 本番移行時の追加対応 |
| --- | --- | --- |
| シークレット管理 | App Service環境変数 | Azure Key Vault参照に切替 |
| HTTPS | App Serviceマネージド証明書 | 同左 |
| CSRFトークン | omniauth-rails_csrf_protection gemで対応 | 同左 |
| IP制限 | App Serviceアクセス制限 | ＋Entra ID Conditional Access Policy |
| ロール管理 | admin/manager/viewer（アプリ側管理） | 同左 |
| シークレット有効期限 | 手動管理（24ヶ月以内に更新） | シークレット期限チェックバッチで自動通知 |

## 7. POCでの実装タスク

| # | タスク | 見積もり |
| --- | --- | --- |
| 1 | Entra IDでアプリ登録・API権限設定 | 0.5日 |
| 2 | OmniAuth設定・コールバック実装 | 0.5日 |
| 3 | Graph APIからのユーザー情報取得 | フェーズ1に含む |
| 4 | usersテーブル・upsertロジック | フェーズ1に含む |
| 5 | ログイン/ログアウトUI | フェーズ1に含む |
| 6 | 権限管理（admin/manager/viewer） | フェーズ1に含む |
| **合計** | | **約1日**（フェーズ1内） |

---

作成日: 2026年2月10日
