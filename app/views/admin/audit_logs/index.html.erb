<% content_for(:page_title) { "操作ログ" } %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h4>操作ログ</h4>
</div>

<div class="card mb-4">
  <div class="card-body">
    <%= form_tag(admin_audit_logs_path, method: :get, class: "row g-3 align-items-end") do %>
      <div class="col-md-3">
        <label class="form-label">リソース種別</label>
        <select name="resource_type" class="form-select">
          <option value="">すべて</option>
          <% @resource_types.each do |rt| %>
            <option value="<%= rt %>" <%= "selected" if params[:resource_type] == rt %>><%= rt %></option>
          <% end %>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">ユーザー</label>
        <%= select_tag :user_id,
            options_from_collection_for_select(@users, :id, :display_name, params[:user_id]&.to_i),
            include_blank: "すべて", class: "form-select" %>
      </div>
      <div class="col-md-2">
        <label class="form-label">開始日</label>
        <input type="date" name="date_from" value="<%= params[:date_from] %>" class="form-control">
      </div>
      <div class="col-md-2">
        <label class="form-label">終了日</label>
        <input type="date" name="date_to" value="<%= params[:date_to] %>" class="form-control">
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-outline-secondary w-100">
          <i class="bi bi-search me-1"></i>検索
        </button>
      </div>
    <% end %>
  </div>
</div>

<div class="card">
  <div class="table-responsive">
    <table class="table table-hover mb-0">
      <thead class="table-light">
        <tr>
          <th>日時</th>
          <th>操作</th>
          <th>リソース</th>
          <th>ユーザー</th>
          <th>IPアドレス</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% @audit_logs.each do |log| %>
          <tr>
            <td><%= log.created_at.strftime("%Y/%m/%d %H:%M") %></td>
            <td>
              <% case log.action %>
              <% when "create" %>
                <span class="badge bg-success">作成</span>
              <% when "update" %>
                <span class="badge bg-primary">更新</span>
              <% when "destroy" %>
                <span class="badge bg-danger">削除</span>
              <% end %>
            </td>
            <td><%= log.resource_type %> #<%= log.resource_id %></td>
            <td><%= log.user&.display_name || "システム" %></td>
            <td><%= log.ip_address %></td>
            <td class="text-end">
              <%= link_to admin_audit_log_path(log), class: "btn btn-sm btn-outline-secondary" do %>
                <i class="bi bi-eye"></i>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<div class="mt-3">
  <%= paginate @audit_logs %>
</div>
