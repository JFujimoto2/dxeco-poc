<% content_for(:page_title) { "ダッシュボード" } %>

<div class="row mb-4">
  <div class="col">
    <h4>SaaS管理ツール POC</h4>
    <p class="text-muted">組織内のSaaSアカウントを一元管理するツールです。</p>
  </div>
</div>

<div class="row g-4 mb-4">
  <div class="col-md-3">
    <%= link_to saases_path, class: "text-decoration-none" do %>
      <div class="card text-center">
        <div class="card-body">
          <i class="bi bi-cloud fs-1 text-primary"></i>
          <h5 class="card-title mt-2"><%= @saas_count %></h5>
          <p class="card-text text-muted">SaaS登録数</p>
        </div>
      </div>
    <% end %>
  </div>
  <div class="col-md-3">
    <%= link_to users_path, class: "text-decoration-none" do %>
      <div class="card text-center">
        <div class="card-body">
          <i class="bi bi-people fs-1 text-success"></i>
          <h5 class="card-title mt-2"><%= @user_count %></h5>
          <p class="card-text text-muted">メンバー数</p>
        </div>
      </div>
    <% end %>
  </div>
  <div class="col-md-3">
    <%= link_to saas_accounts_path, class: "text-decoration-none" do %>
      <div class="card text-center">
        <div class="card-body">
          <i class="bi bi-person-badge fs-1 text-info"></i>
          <h5 class="card-title mt-2"><%= @account_count %></h5>
          <p class="card-text text-muted">アクティブアカウント</p>
        </div>
      </div>
    <% end %>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <i class="bi bi-exclamation-triangle fs-1 text-warning"></i>
        <h5 class="card-title mt-2"><%= @attention_count %></h5>
        <p class="card-text text-muted">要対応</p>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-md-4">
    <%= link_to approval_requests_path, class: "text-decoration-none" do %>
      <div class="card text-center border-warning">
        <div class="card-body">
          <i class="bi bi-check2-square fs-1 text-warning"></i>
          <h5 class="card-title mt-2"><%= @pending_approval_count %></h5>
          <p class="card-text text-muted">承認待ち申請</p>
        </div>
      </div>
    <% end %>
  </div>
  <div class="col-md-4">
    <%= link_to tasks_path, class: "text-decoration-none" do %>
      <div class="card text-center">
        <div class="card-body">
          <i class="bi bi-list-task fs-1 text-primary"></i>
          <h5 class="card-title mt-2"><%= @active_task_count %></h5>
          <p class="card-text text-muted">進行中タスク</p>
        </div>
      </div>
    <% end %>
  </div>
  <div class="col-md-4">
    <%= link_to surveys_path, class: "text-decoration-none" do %>
      <div class="card text-center">
        <div class="card-body">
          <i class="bi bi-clipboard-check fs-1 text-success"></i>
          <h5 class="card-title mt-2"><%= @active_survey_count %></h5>
          <p class="card-text text-muted">配信中サーベイ</p>
        </div>
      </div>
    <% end %>
  </div>
</div>

<% if @expiring_contracts.any? || @expired_contracts_count > 0 %>
  <div class="card mt-4 border-warning">
    <div class="card-header bg-warning bg-opacity-10">
      <h6 class="mb-0"><i class="bi bi-exclamation-triangle me-1 text-warning"></i>契約更新アラート</h6>
    </div>
    <div class="card-body">
      <% if @expired_contracts_count > 0 %>
        <div class="alert alert-danger py-2 mb-3">
          <i class="bi bi-x-circle me-1"></i>期限切れの契約が <strong><%= @expired_contracts_count %>件</strong> あります
        </div>
      <% end %>

      <% if @expiring_contracts.any? %>
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>SaaS名</th>
              <th>プラン</th>
              <th>期限日</th>
              <th>残日数</th>
            </tr>
          </thead>
          <tbody>
            <% @expiring_contracts.each do |contract| %>
              <tr>
                <td><%= link_to contract.saas.name, saas_path(contract.saas) %></td>
                <td><%= contract.plan_name %></td>
                <td><%= contract.expires_on.strftime("%Y/%m/%d") %></td>
                <td>
                  <% days_left = (contract.expires_on - Date.current).to_i %>
                  <% badge_class = days_left <= 7 ? "bg-danger" : "bg-warning text-dark" %>
                  <span class="badge <%= badge_class %>"><%= days_left %>日</span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
    </div>
  </div>
<% end %>

<% if current_user.admin? && @recent_audit_logs.present? %>
  <div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h6 class="mb-0"><i class="bi bi-journal-text me-1"></i>最近の操作</h6>
      <%= link_to "すべて表示", admin_audit_logs_path, class: "btn btn-sm btn-outline-secondary" %>
    </div>
    <div class="card-body p-0">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>日時</th>
            <th>操作</th>
            <th>リソース</th>
            <th>ユーザー</th>
          </tr>
        </thead>
        <tbody>
          <% @recent_audit_logs.each do |log| %>
            <tr>
              <td><%= log.created_at.strftime("%m/%d %H:%M") %></td>
              <td>
                <% case log.action %>
                <% when "create" %>
                  <span class="badge bg-success">作成</span>
                <% when "update" %>
                  <span class="badge bg-primary">更新</span>
                <% when "destroy" %>
                  <span class="badge bg-danger">削除</span>
                <% end %>
              </td>
              <td><%= log.resource_type %> #<%= log.resource_id %></td>
              <td><%= log.user&.display_name || "システム" %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% end %>
