# SaaS管理ツール POC インフラ構成

---

## 1. 方針

POCはシンプルに素早くデプロイし、デモできる状態にすることを優先する。
個人利用のため **コスト最小化** を最優先とし、本番移行時にIaC化・セキュリティ強化を行う。

| 項目 | POC | 本番移行時 |
| --- | --- | --- |
| 構成管理 | Azure CLI スクリプト（`infra/`） | Terraform |
| 環境 | 1環境（dev兼デモ） | dev / prod の2環境 |
| デプロイ | GitHub Actions → Azure Container Apps | 同左 |
| セキュリティ | Entra ID認証（未認証は全てログインへ） | + VNet統合 + Key Vault + 監視 |

---

## 2. POC構成（Azure Container Apps）

Entra IDと同一テナントで管理でき、認証との親和性が最も高いAzureを選択する。
App Service は Ruby ビルトインサポートが終了（2023年4月）しているため、**Container Apps（従量課金）** を採用。

### 実リソース

| コンポーネント | サービス | スペック | 月額目安 |
| --- | --- | --- | --- |
| アプリケーション | Azure Container Apps (Consumption) | 0.5 vCPU / 1 GiB RAM, min 0〜max 1レプリカ | ~$15-20 |
| データベース | Azure Database for PostgreSQL Flexible Server | Burstable B1ms（1 vCore / 2 GiB RAM / 32 GB SSD） | ~$25 |
| コンテナレジストリ | Azure Container Registry (Basic) | 10 GB ストレージ | ~$5 |
| SSL証明書 | Container Apps マネージド証明書 | 無料 | $0 |
| **合計** | | | **~$45-50/月** |

> **無料トリアル:** $200クレジット（30日間）。普段はDB停止・replicas=0でコスト削減。

### 構成図

```
[ユーザー]
  ↓ HTTPS（Container Apps マネージド証明書）
[Azure Container Apps] ── Rails 8 Docker コンテナ
  │  ├─ Thruster（HTTP/2 プロキシ, port 3000）
  │  ├─ Puma（Web サーバー, port 3001）
  │  └─ Solid Queue（バックグラウンドジョブ、Puma プラグイン）
  ↓
[Azure Database for PostgreSQL Flexible Server]
  ├─ primary: dxceco_poc_production
  ├─ cache:   dxceco_poc_production_cache  (Solid Cache)
  ├─ queue:   dxceco_poc_production_queue  (Solid Queue)
  └─ cable:   dxceco_poc_production_cable  (Solid Cable)

[Azure Container Registry] ── Docker イメージ保管

外部API:
  → Microsoft Graph API（Entra ID認証・ユーザー同期）
  → Power Automate Workflows Webhook（Teams通知）
```

### セキュリティ（POC最低限）

| 対策 | 方法 |
| --- | --- |
| 認証 | Entra ID SSO（未認証アクセスは全てログイン画面へリダイレクト） |
| HTTPS | Container Apps マネージド証明書で強制（`config.assume_ssl = true`） |
| DB接続 | PostgreSQL のファイアウォールで Container Apps + 許可IPのみ |
| シークレット | Container Apps の環境変数として管理 |
| コンテナ | 非root ユーザー（uid 1000）で実行 |

---

## 3. 技術構成

### Docker イメージ

既存の `Dockerfile` を使用（Rails 8 標準のマルチステージビルド）:

- ベースイメージ: `ruby:3.3.2-slim`
- jemalloc 有効（メモリ最適化）
- Thruster（HTTP/2 プロキシ / アセット圧縮・キャッシュ）
- 非root ユーザー実行
- `bin/docker-entrypoint` で起動時に `db:prepare` 自動実行

### ポート構成

コンテナ内のポート構成（非rootユーザーのため port 80 は使用不可）:

| プロセス | ポート | 環境変数 |
| --- | --- | --- |
| Thruster（外部受付） | 3000 | `HTTP_PORT=3000` |
| Puma（Rails） | 3001 | `PORT=3001`, `TARGET_PORT=3001` |

Container Apps の ingress は port 3000 に接続し、Thruster が Puma (3001) にプロキシする。

### Solid Queue（バックグラウンドジョブ）

別コンテナは立てず、Puma プラグインとして同一プロセス内で実行:

```
SOLID_QUEUE_IN_PUMA=true
```

これにより Container Apps のレプリカは **1つだけ** でWeb + ジョブの両方を処理。

### データベース

`config/database.yml` の本番設定に従い、4つのデータベースを作成:

| DB名 | 用途 |
| --- | --- |
| `dxceco_poc_production` | アプリケーションデータ |
| `dxceco_poc_production_cache` | Solid Cache（Rails キャッシュ） |
| `dxceco_poc_production_queue` | Solid Queue（ジョブキュー） |
| `dxceco_poc_production_cable` | Solid Cable（Action Cable） |

`DATABASE_URL` 環境変数でプライマリDBに接続し、cache/queue/cable は同一サーバー上の別DBとして設定。

---

## 4. デプロイ済みリソース

### リソース一覧

| リソース | 名前 | リソースグループ |
| --- | --- | --- |
| Container App | `app-dxceco-poc` | `rg-dxceco-poc` |
| Container Apps Environment | `cae-dxceco-poc` | `rg-dxceco-poc` |
| PostgreSQL Flexible Server | `psql-dxceco-poc` | `rg-dxceco-poc` |
| Container Registry | `acrdxcecopoc` | `rg-dxceco-poc` |

### アプリURL

```
https://app-dxceco-poc.politehill-446b6d62.japaneast.azurecontainerapps.io
```

---

## 5. CI/CD（GitHub Actions）

### ブランチ戦略

```
feature/xxx ──PR──▶ main ──PR──▶ prod ──自動デプロイ──▶ Azure
```

- `main`: 開発統合ブランチ（PRマージのみ、直接push不可）
- `prod`: 本番リリースブランチ（PRマージで自動デプロイ）
- 両ブランチとも CI 全5ジョブ通過必須

### CI（`.github/workflows/ci.yml` — main への push/PR 時）

5ジョブ: lint / scan_ruby / scan_js / test / e2e

### CD（`.github/workflows/deploy.yml` — prod への push 時）

```
Azure ログイン → ACR ログイン → Docker ビルド & プッシュ → Container Apps 更新
```

所要時間: 約2分30秒

### GitHub Secrets（CD 用）

| Secret 名 | 用途 |
| --- | --- |
| `AZURE_CLIENT_ID` | サービスプリンシパルのクライアントID |
| `AZURE_CLIENT_SECRET` | サービスプリンシパルのシークレット |
| `AZURE_TENANT_ID` | Azure テナントID |
| `AZURE_SUBSCRIPTION_ID` | Azure サブスクリプションID |
| `ACR_LOGIN_SERVER` | ACR ログインサーバー（`acrdxcecopoc.azurecr.io`） |
| `ACR_NAME` | ACR 名（`acrdxcecopoc`） |

サービスプリンシパル: `github-deploy-dxceco-poc`

---

## 6. 環境変数

Container Apps の環境変数として設定:

### 必須

| 変数名 | 用途 | 例 |
| --- | --- | --- |
| `RAILS_ENV` | Rails 環境 | `production` |
| `RAILS_MASTER_KEY` | credentials 復号キー | `config/master.key` の内容 |
| `DATABASE_URL` | PostgreSQL 接続URL | `postgres://user:pass@host:5432/db?sslmode=require` |
| `DXCECO_POC_DATABASE_PASSWORD` | DB パスワード（cache/queue/cable用） | - |
| `DB_HOST` | DB ホスト名（cache/queue/cable用） | `psql-dxceco-poc.postgres.database.azure.com` |
| `DB_USERNAME` | DB ユーザー名（cache/queue/cable用） | `dxcecopoc` |
| `APP_URL` | アプリの公開URL | `https://app-dxceco-poc.politehill-446b6d62...` |
| `ENTRA_CLIENT_ID` | Entra ID クライアントID | - |
| `ENTRA_CLIENT_SECRET` | Entra ID シークレット | - |
| `ENTRA_TENANT_ID` | テナントID | - |
| `SOLID_QUEUE_IN_PUMA` | Puma 内で Solid Queue 起動 | `true` |
| `HTTP_PORT` | Thruster リッスンポート | `3000` |
| `TARGET_PORT` | Thruster → Puma プロキシ先 | `3001` |
| `PORT` | Puma リッスンポート | `3001` |

### オプション

| 変数名 | 用途 | デフォルト |
| --- | --- | --- |
| `TEAMS_WEBHOOK_URL` | Teams 通知 Webhook | 未設定でスキップ |
| `TEAMS_WEBHOOK_SURVEY_URL` | サーベイ専用 Webhook | `TEAMS_WEBHOOK_URL` |
| `SMTP_ADDRESS` | SMTP サーバー | 未設定でメール無効 |
| `SMTP_PORT` | SMTP ポート | `587` |
| `SMTP_USERNAME` | SMTP ユーザー | - |
| `SMTP_PASSWORD` | SMTP パスワード | - |
| `SMTP_DOMAIN` | SMTP HELO ドメイン | - |
| `MAILER_FROM` | 送信元アドレス | - |
| `RAILS_LOG_LEVEL` | ログレベル | `info` |

---

## 7. 運用

### 起動・停止（コスト節約）

普段はDB停止 + replicas=0 で課金を最小化。

```bash
# Azure ログイン（セッション切れ時のみ）
az login

# DB 起動（1-2分）
az postgres flexible-server start \
  --resource-group rg-dxceco-poc --name psql-dxceco-poc

# DB 停止
az postgres flexible-server stop \
  --resource-group rg-dxceco-poc --name psql-dxceco-poc
```

Container Apps は min-replicas=0 のため、アクセスがなければ自動停止、アクセスが来ると自動起動（コールドスタート: 数十秒）。

> **注意:** DB を停止したまま7日経つと Azure が自動で再起動する。

### デプロイ

```bash
# 通常: prod ブランチへの PR マージで自動デプロイ
gh pr create --base prod --head main --title "Release: xxx"

# 手動デプロイ
az acr login --name acrdxcecopoc
docker build -t acrdxcecopoc.azurecr.io/dxceco-poc:latest .
docker push acrdxcecopoc.azurecr.io/dxceco-poc:latest
az containerapp update --name app-dxceco-poc --resource-group rg-dxceco-poc \
  --image acrdxcecopoc.azurecr.io/dxceco-poc:latest
```

### ログ確認

```bash
az containerapp logs show --name app-dxceco-poc --resource-group rg-dxceco-poc --follow
```

### Rails コンソール

```bash
az containerapp exec --name app-dxceco-poc --resource-group rg-dxceco-poc \
  --command "bin/rails console"
```

---

## 8. 本番移行時の拡張計画

| 項目 | 追加内容 | 月額追加 |
| --- | --- | --- |
| シークレット管理 | Azure Key Vault | ほぼ無料 |
| 監視 | Azure Monitor + Log Analytics | ほぼ無料 |
| ネットワーク | VNet統合（Container Apps ↔ PostgreSQL） | 追加なし |
| IaC | Terraform 化 | - |
| バックアップ | PostgreSQL 自動バックアップ（7日保持 ※デフォルト有効） | 追加なし |
| 環境分離 | dev / prod の2環境 | ~$45 |

### コスト比較

| 構成 | 月額 | 年額 |
| --- | --- | --- |
| POC（Container Apps + PostgreSQL） | ~$45-50 | ~$540-600 |
| POC（DB停止運用、実質） | ~$10-20 | ~$120-240 |
| 本番（2環境） | ~$100 | ~$1,200 |
| **DXECO（500名・オプション込み）** | **~$1,130** | **~$13,600** |

---

作成日: 2026年2月10日
更新日: 2026年2月15日（デプロイ実績に基づき全面更新）
