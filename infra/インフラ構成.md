# SaaS管理ツール POC インフラ構成案

---

## 1. 方針

POCはシンプルに素早くデプロイし、デモできる状態にすることを優先する。
個人利用のため **コスト最小化** を最優先とし、本番移行時にIaC化・セキュリティ強化を行う。

| 項目 | POC | 本番移行時 |
| --- | --- | --- |
| 構成管理 | Azure CLI スクリプト（`infra/`） | Terraform |
| 環境 | 1環境（dev兼デモ） | dev / prod の2環境 |
| デプロイ | GitHub Actions → Azure Container Apps | 同左 |
| セキュリティ | Entra ID認証（未認証は全てログインへ） | + VNet統合 + Key Vault + 監視 |

---

## 2. POC構成（Azure Container Apps）

Entra IDと同一テナントで管理でき、認証との親和性が最も高いAzureを選択する。
App Service は Ruby ビルトインサポートが終了（2023年4月）しているため、**Container Apps（従量課金）** を採用。

### コスト

| コンポーネント | サービス | スペック | 月額目安 |
| --- | --- | --- | --- |
| アプリケーション | Azure Container Apps (Consumption) | 0.25 vCPU / 0.5 GiB RAM, 1レプリカ | ~1,050円 |
| データベース | Azure Database for PostgreSQL Flexible Server | Burstable B1ms（1 vCore / 2 GiB RAM / 32 GB SSD） | ~2,550円 |
| コンテナレジストリ | Azure Container Registry (Basic) | 10 GB ストレージ | ~750円 |
| SSL証明書 | Container Apps マネージド証明書 | 無料 | 0円 |
| **合計** | | | **~4,350円/月** |

> **無料アカウント活用:** 新規 Azure 無料アカウントなら PostgreSQL が **12ヶ月無料**（B1ms + 32 GB）。
> その場合の月額は **~1,800円**。

### 構成図

```
[ユーザー]
  ↓ HTTPS（Container Apps マネージド証明書）
[Azure Container Apps] ── Rails 8 Docker コンテナ
  │  ├─ Puma（Web サーバー）
  │  ├─ Thruster（HTTP プロキシ / アセットキャッシュ）
  │  └─ Solid Queue（バックグラウンドジョブ、Puma プラグイン）
  ↓
[Azure Database for PostgreSQL Flexible Server]
  ├─ primary: dxceco_poc_production
  ├─ cache:   dxceco_poc_production_cache  (Solid Cache)
  ├─ queue:   dxceco_poc_production_queue  (Solid Queue)
  └─ cable:   dxceco_poc_production_cable  (Solid Cable)

[Azure Container Registry] ── Docker イメージ保管

外部API:
  → Microsoft Graph API（Entra ID認証・ユーザー同期）
  → Power Automate Workflows Webhook（Teams通知）
```

### セキュリティ（POC最低限）

| 対策 | 方法 |
| --- | --- |
| 認証 | Entra ID SSO（未認証アクセスは全てログイン画面へリダイレクト） |
| HTTPS | Container Apps マネージド証明書で強制 |
| DB接続 | PostgreSQL のファイアウォールで Container Apps の送信IPのみ許可 |
| シークレット | Container Apps のシークレット機能で管理（環境変数経由） |
| コンテナ | 非root ユーザー（uid 1000）で実行 |

---

## 3. 技術構成

### Docker イメージ

既存の `Dockerfile` を使用（Rails 8 標準のマルチステージビルド）:

- ベースイメージ: `ruby:3.3.2-slim`
- jemalloc 有効（メモリ最適化）
- Thruster（HTTP プロキシ / アセット圧縮・キャッシュ）
- 非root ユーザー実行
- `bin/docker-entrypoint` で起動時に `db:prepare` 自動実行

### Solid Queue（バックグラウンドジョブ）

別コンテナは立てず、Puma プラグインとして同一プロセス内で実行:

```
SOLID_QUEUE_IN_PUMA=true
```

これにより Container Apps のレプリカは **1つだけ** でWeb + ジョブの両方を処理。

### データベース

`config/database.yml` の本番設定に従い、4つのデータベースを作成:

| DB名 | 用途 |
| --- | --- |
| `dxceco_poc_production` | アプリケーションデータ |
| `dxceco_poc_production_cache` | Solid Cache（Rails キャッシュ） |
| `dxceco_poc_production_queue` | Solid Queue（ジョブキュー） |
| `dxceco_poc_production_cable` | Solid Cable（Action Cable） |

`DATABASE_URL` 環境変数でプライマリDBに接続し、cache/queue/cable は同一サーバー上の別DBとして設定。

---

## 4. Azure 事前準備

`setup.sh` を実行する前に、以下の準備が必要。

### 4.1 Azure アカウント & サブスクリプション

1. **Azure アカウント作成**（未作成の場合）
   - https://azure.microsoft.com/ja-jp/pricing/purchase-options/azure-account にアクセス
   - 「無料で始める」から作成（クレジットカード必要、初年度 ¥22,500 分の無料クレジット付き）
   - 無料アカウントなら **PostgreSQL B1ms が12ヶ月無料**

2. **サブスクリプション確認**
   - Azure Portal（https://portal.azure.com）→「サブスクリプション」
   - 無料アカウントなら「Azure subscription 1」が自動作成されている

### 4.2 Azure CLI インストール & ログイン

```bash
# === macOS ===
brew install azure-cli

# === Ubuntu / WSL ===
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

# === Windows ===
# https://learn.microsoft.com/ja-jp/cli/azure/install-azure-cli-windows からインストーラーをダウンロード
```

ログイン:

```bash
az login
# ブラウザが開くので Azure アカウントでサインイン

# 正しいサブスクリプションが選択されているか確認
az account show --query "{name:name, id:id}" -o table

# 別のサブスクリプションを使う場合
az account set --subscription "<サブスクリプションID>"
```

### 4.3 Docker インストール

```bash
# === macOS ===
brew install --cask docker
# Docker Desktop を起動

# === Ubuntu / WSL ===
sudo apt-get update
sudo apt-get install -y docker.io
sudo usermod -aG docker $USER
# ログアウト → 再ログインで反映

# 動作確認
docker --version
```

### 4.4 Entra ID アプリ登録（SSO 用）

Azure Portal での操作:

1. **アプリの登録**
   - Azure Portal → 「Microsoft Entra ID」 → 「アプリの登録」 → 「新規登録」
   - 名前: `dxceco-poc`（任意）
   - サポートされているアカウントの種類: 「この組織ディレクトリのみ」
   - リダイレクト URI: **後で追加**（Container Apps のURL が確定してから）
   - 「登録」をクリック

2. **クライアントシークレットの作成**
   - 登録したアプリ → 「証明書とシークレット」 → 「新しいクライアント シークレット」
   - 説明: `dxceco-poc`、有効期限: 任意（推奨: 24ヶ月）
   - 「追加」後に表示される **「値」をコピー** → `.env.azure` の `ENTRA_CLIENT_SECRET` に設定
   - ⚠ この値は一度しか表示されないので必ずコピー

3. **必要な値をメモ**
   - アプリ「概要」ページから:
     - **アプリケーション (クライアント) ID** → `ENTRA_CLIENT_ID`
     - **ディレクトリ (テナント) ID** → `ENTRA_TENANT_ID`

4. **API のアクセス許可**（Graph API ユーザー同期用）
   - 「API のアクセス許可」 → 「アクセス許可の追加」 → 「Microsoft Graph」
   - 「アプリケーションの許可」を選択
   - 以下を追加:
     - `User.Read.All`（ユーザー情報の読み取り）
   - 「管理者の同意を与える」をクリック

5. **リダイレクト URI の追加**（setup.sh 実行後）
   - 「認証」 → 「プラットフォームを追加」 → 「Web」
   - リダイレクト URI: `https://<Container Apps のドメイン>/auth/entra_id/callback`
   - 「構成」をクリック

### 4.5 サービスプリンシパル作成（GitHub Actions 用）

GitHub Actions から Azure にデプロイするために必要。手動デプロイのみなら不要。

```bash
# サブスクリプションIDを取得
SUBSCRIPTION_ID=$(az account show --query id -o tsv)

# サービスプリンシパルを作成（Contributor ロール）
az ad sp create-for-rbac \
  --name "github-actions-dxceco-poc" \
  --role Contributor \
  --scopes /subscriptions/$SUBSCRIPTION_ID \
  --sdk-auth
```

出力される JSON 全体をコピーして、GitHub リポジトリに設定:

- GitHub → リポジトリ → Settings → Secrets and variables → Actions → 「New repository secret」
- Name: `AZURE_CREDENTIALS`
- Value: 上記の JSON を丸ごと貼り付け

その他の GitHub Secrets も追加:

| Secret 名 | 値 |
|---|---|
| `AZURE_CREDENTIALS` | サービスプリンシパルの JSON |
| `RAILS_MASTER_KEY` | `config/master.key` の内容 |
| `ACR_NAME` | Container Registry 名（例: `acrdxcecopoc`） |
| `CONTAINER_APP_NAME` | Container App 名（例: `app-dxceco-poc`） |
| `AZURE_RESOURCE_GROUP` | リソースグループ名（例: `rg-dxceco-poc`） |

---

## 5. リソース作成 & デプロイ手順

### 5.1 Azure リソース一括作成

`infra/setup.sh` スクリプトで全リソースを作成:

```bash
cd infra
cp .env.azure.example .env.azure
# .env.azure を編集（パスワード等を設定）
bash setup.sh
```

スクリプトが以下を自動作成:
1. リソースグループ
2. Azure Container Registry (Basic)
3. PostgreSQL Flexible Server (B1ms) + 4データベース
4. Container Apps 環境 + アプリ

### 5.2 Docker イメージのビルド & プッシュ

```bash
# ACR にログイン
az acr login --name <ACR名>

# イメージビルド & プッシュ
docker build -t <ACR名>.azurecr.io/dxceco-poc:latest .
docker push <ACR名>.azurecr.io/dxceco-poc:latest
```

### 5.3 初回デプロイ

```bash
# Container Apps にイメージをデプロイ
az containerapp update \
  --name app-dxceco-poc \
  --resource-group rg-dxceco-poc \
  --image <ACR名>.azurecr.io/dxceco-poc:latest
```

### 5.4 Entra ID リダイレクトURI追加

`setup.sh` 完了後に表示される Container Apps のドメインを使って設定:

1. Azure Portal → 「Microsoft Entra ID」 → 「アプリの登録」 → `dxceco-poc`
2. 「認証」 → 「リダイレクト URI を追加」
3. 以下を追加:

```
https://<Container Apps のドメイン>/auth/entra_id/callback
```

例: `https://app-dxceco-poc.wonderfulmushroom-xxxxxxxx.japaneast.azurecontainerapps.io/auth/entra_id/callback`

### 5.5 カスタムドメイン設定（任意）

```bash
az containerapp hostname add \
  --name app-dxceco-poc \
  --resource-group rg-dxceco-poc \
  --hostname saas-mgmt.example.com

# マネージド証明書を設定
az containerapp hostname bind \
  --name app-dxceco-poc \
  --resource-group rg-dxceco-poc \
  --hostname saas-mgmt.example.com \
  --environment env-dxceco-poc \
  --validation-method CNAME
```

---

## 6. 環境変数

Container Apps のシークレット / 環境変数として設定:

### 必須

| 変数名 | 用途 | 例 |
| --- | --- | --- |
| `RAILS_ENV` | Rails 環境 | `production` |
| `RAILS_MASTER_KEY` | credentials 復号キー | `config/master.key` の内容 |
| `DATABASE_URL` | PostgreSQL 接続URL | `postgres://user:pass@host:5432/db?sslmode=require` |
| `DXCECO_POC_DATABASE_PASSWORD` | DB パスワード（cache/queue/cable用） | - |
| `APP_URL` | アプリの公開URL | `https://app-dxceco-poc.azurecontainerapps.io` |
| `ENTRA_CLIENT_ID` | Entra ID クライアントID | - |
| `ENTRA_CLIENT_SECRET` | Entra ID シークレット | - |
| `ENTRA_TENANT_ID` | テナントID | - |
| `SOLID_QUEUE_IN_PUMA` | Puma 内で Solid Queue 起動 | `true` |

### オプション

| 変数名 | 用途 | デフォルト |
| --- | --- | --- |
| `TEAMS_WEBHOOK_URL` | Teams 通知 Webhook | 未設定でスキップ |
| `TEAMS_WEBHOOK_SURVEY_URL` | サーベイ専用 Webhook | `TEAMS_WEBHOOK_URL` |
| `SMTP_ADDRESS` | SMTP サーバー | 未設定でメール無効 |
| `SMTP_PORT` | SMTP ポート | `587` |
| `SMTP_USERNAME` | SMTP ユーザー | - |
| `SMTP_PASSWORD` | SMTP パスワード | - |
| `SMTP_DOMAIN` | SMTP HELO ドメイン | - |
| `MAILER_FROM` | 送信元アドレス | - |

---

## 7. CI/CD（GitHub Actions）

`infra/deploy.yml` を `.github/workflows/` にコピーして使用。

```
push to main → Docker build → ACR push → Container Apps 更新
```

必要な GitHub Secrets:
- `AZURE_CREDENTIALS` — サービスプリンシパルの JSON
- `RAILS_MASTER_KEY` — config/master.key の内容

---

## 8. 運用

### デプロイ

```bash
# 手動デプロイ（GitHub Actions が設定済みなら push で自動）
docker build -t <ACR名>.azurecr.io/dxceco-poc:latest .
docker push <ACR名>.azurecr.io/dxceco-poc:latest
az containerapp update --name app-dxceco-poc --resource-group rg-dxceco-poc \
  --image <ACR名>.azurecr.io/dxceco-poc:latest
```

### ログ確認

```bash
az containerapp logs show --name app-dxceco-poc --resource-group rg-dxceco-poc --follow
```

### Rails コンソール

```bash
az containerapp exec --name app-dxceco-poc --resource-group rg-dxceco-poc \
  --command "bin/rails console"
```

### コスト管理

- Azure Portal → Cost Management で日次コストを確認
- PostgreSQL を使わない時間帯は停止可能（`az postgres flexible-server stop`）
- Container Apps は min-replica=0 に設定すると使わない時は課金ゼロ（ただしコールドスタートあり）

---

## 9. 本番移行時の拡張計画

| 項目 | 追加内容 | 月額追加 |
| --- | --- | --- |
| シークレット管理 | Azure Key Vault | ほぼ無料 |
| 監視 | Azure Monitor + Log Analytics | ほぼ無料 |
| ネットワーク | VNet統合（Container Apps ↔ PostgreSQL） | 追加なし |
| IaC | Terraform 化 | - |
| バックアップ | PostgreSQL 自動バックアップ（7日保持 ※デフォルト有効） | 追加なし |
| 環境分離 | dev / prod の2環境 | ~4,350円 |

### コスト比較

| 構成 | 月額 | 年額 |
| --- | --- | --- |
| POC（Container Apps + PostgreSQL） | ~4,350円 | ~52,200円 |
| POC（無料アカウント、初年度） | ~1,800円 | ~21,600円 |
| 本番（2環境） | ~10,000円 | ~120,000円 |
| **DXECO（500名・オプション込み）** | **~170,000円** | **~2,040,000円** |

---

作成日: 2026年2月10日
更新日: 2026年2月11日（Container Apps 構成に変更）
